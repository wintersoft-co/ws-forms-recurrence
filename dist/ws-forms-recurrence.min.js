!function(e,n){"use strict";var t,a,l,s,i=n.luxon&&n.luxon.DateTime;s={monday:{byday:"MO",index:1},tuesday:{byday:"TU",index:2},wednesday:{byday:"WE",index:3},thursday:{byday:"TH",index:4},friday:{byday:"FR",index:5},saturday:{byday:"SA",index:6},sunday:{byday:"SU",index:0}},l={modes:["weekly","monthly"],debounce:200,cssPrefix:"ws-form",timezone:null,days:Object.keys(s),minDays:0,maxDays:7,strings:{frequencyLabel:"Frequency",frequencyHint:null,weekly:"Weekly",weeksLabel:"Every",weeksHint:"weeks(s)",daysLabel:"On",daysHint:null,dayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],monthly:"Monthly",monthsLabel:"Every",monthsHint:"month(s)",untilLabel:null,untilHint:null,untilEnabledLabel:"Until"}},a={weekly:function(e){var n=this;n.plugin=e,n.init()},monthly:function(e){var n=this;n.plugin=e,n.init()}},a.weekly.prototype={init:function(){var n,t,a,l,i,r,d,o=this,u=o.plugin,c=u.settings,p=c.strings,f=u.getCls.bind(u);n=o.$el=e('<div class="'+f("fieldset","fieldset-weekly")+'"></div>'),l=e('<label class="'+f("field","field-weeks")+'"></label>'),p.weeksLabel&&l.append('<span class="'+f("field-label")+'">'+p.weeksLabel+"</span>"),t=o.$weeks=e('<input type="number" min="1" pattern="/^d+$/"/>'),t.attr("value",i=1),r=function(e){var n=t.val().replace(/[^\d]/g,"");t.val(n),i!==n&&u._triggerChange(),i=n,e&&e.stopPropagation()},t.on("change",r),t.on("keyup",function(){clearTimeout(d),d=setTimeout(r,c.debounce)}),e('<span class="'+f("field-element")+'"></span>').append(t).appendTo(l),p.weeksHint&&l.append('<span class="'+f("field-hint")+'">'+p.weeksHint+"</span>"),n.append(l),l=e('<div class="'+f("field","field-days")+'"></div>'),p.daysLabel&&l.append('<span class="'+f("field-label")+'">'+p.daysLabel+"</span>"),a=e('<span class="'+f("field-element")+'"></span>'),o.days=[],c.days.forEach(function(n,t){if(t=s[n]){var l=e('<button type="button" class="'+f("day-"+t.index)+'">'+p.dayNames[t.index]+"</button>");l.on("click",function(){var e=u.settings.maxDays,t=o.getSelectedDays(),a=t.filter(function(e){return e!=n});a.length==t.length&&a.push(n),a.length>e&&a.shift(),o.setSelectedDays(a)&&u._triggerChange()}),a.append(l),o.days.push({name:n,selected:!1,$el:l})}}),l.append(a),n.append(l),p.daysHint&&l.append('<span class="'+f("field-hint")+'">'+p.daysHint+"</span>"),n.append(l)},getSelectedDays:function(){var e=this,n=[];return e.days.forEach(function(e){e.selected&&n.push(e.name)}),n},setSelectedDays:function(e){var n=this;return n.isValidDays(e)?(n.days.forEach(function(t){t.selected=e.indexOf(t.name)>-1,t.$el.toggleClass(n.plugin.getCls("active"),t.selected)}),!0):(console.warn("Invalid days set: ["+e+"]"),!1)},toRuleObj:function(){var e,n,t=this;return n=t.getSelectedDays().map(function(e){return s[e].byday}),e={freq:"WEEKLY",interval:parseInt(t.$weeks.val())},n.length&&(e.byday=n),e},fromRuleObj:function(n){var t=this,a=[];t.$weeks.val(n.interval),n.byday&&e.each(s,function(e,t){n.byday.indexOf(t.byday)>-1&&a.push(e)}),t.setSelectedDays(a)},isRule:function(e){return"WEEKLY"===e.freq},isValidDays:function(e){var n=this,t=n.plugin.settings,a=t.minDays,l=t.maxDays;return("number"!=typeof a||e.length>=a)&&("number"!=typeof l||e.length<=l)}},a.monthly.prototype={init:function(){var n,t,a,l,s,i,r=this,d=r.plugin,o=d.settings,u=o.strings,c=d.getCls.bind(d);n=r.$el=e('<div class="'+c("fieldset","fieldset-monthly")+'"></div>'),a=e('<label class="'+c("field","field-months")+'"></label>'),u.monthsLabel&&a.append('<span class="'+c("field-label")+'">'+u.monthsLabel+"</span>"),t=r.$months=e('<input type="number" min="1" pattern="/^d+$/"/>'),t.attr("value",l=1),s=function(e){var n=t.val().replace(/[^\d]/g,"");t.val(n),l!==n&&d._triggerChange(),l=n,e&&e.stopPropagation()},t.on("change",s),t.on("keyup",function(){clearTimeout(i),i=setTimeout(s,o.debounce)}),e('<span class="'+c("field-element")+'"></span>').append(t).appendTo(a),u.monthsHint&&a.append('<span class="'+c("field-hint")+'">'+u.monthsHint+"</span>"),n.append(a)},toRuleObj:function(){return{freq:"MONTHLY",interval:parseInt(this.$months.val())}},fromRuleObj:function(e){this.$months.val(e.interval)},isRule:function(e){return"MONTHLY"===e.freq}},t=function(n,t){var a=this;a.$el=e(n),a.element=a.$el[0],a.settings=jQuery.extend({},l,t),a.settings.strings=jQuery.extend({},l.strings,t.strings),a.currentMode=null,a.init()},t.prototype={modes:null,init:function(){var n,t,l,s,i,r,d=this,o=d.settings,u=o.strings,c=d.getCls.bind(d),p=d.$el;p.addClass(c("wrap","wrap-recurrence")),n=e('<label class="'+c("field","field-frequency")+'"></label>'),u.frequencyLabel&&n.append('<span class="'+c("field-label")+'">'+u.frequencyLabel+"</span>"),t=d.$frequency=e("<select></select>"),t.on("change",function(){var n=t.val();if(!d.modes[n])throw new Error("Unknown mode selected: "+n);e.each(d.modes,function(e,t){t.$el.toggle(e===n)}),d.currentMode=n}),e('<span class="'+c("field-element")+'"></span>').append(t).appendTo(n),u.frequencyHint&&n.append('<span class="'+c("field-hint")+'">'+u.frequencyHint+"</span>"),p.append(n),d.modes={},o.modes.forEach(function(e){var n=new a[e](d),l=n.$el;l.hide(),p.append(l),t.append('<option value="'+e+'">'+u[e]+"</option>"),d.modes[e]=n}),o.modes.length<2&&n.hide(),n=e('<label class="'+c("field","field-until")+'"></label>'),u.untilLabel&&n.append('<span class="'+c("field-label")+'">'+u.untilLabel+"</span>"),s=d.$untilEnabled=e('<input type="checkbox"/>'),l=d.$until=e('<input type="date"/>'),i=new Date,r=i.getMonth()+1,r>11&&i.setFullYear(i.getFullYear()+1),i.setMonth(r%12),l.attr("value",i.toISOString().substring(0,10)),s.on("change",function(){l.toggle(s.is(":checked"))}),s.trigger("change"),e('<span class="'+c("field-element")+'"></span>').append(s).append(u.untilEnabledLabel&&'<span class="'+c("field-label")+'">'+u.untilEnabledLabel+"</span>").append(l).appendTo(n),u.untilHint&&n.append('<span class="'+c("field-hint")+'">'+u.untilHint+"</span>"),p.append(n),t.trigger("change"),d.fromRule(o.recurrenceRule||d.toRule())},getMode:function(e){var n=this,t=n.modes;return e&&t[e]||n.currentMode&&t[n.currentMode]},toRuleObj:function(){var e,n=this,t=n.getMode().toRuleObj();return n.$untilEnabled.is(":checked")&&(e=n.getUntilDate())&&(t.until=e),t},toRule:function(){var n=this,t=n.toRuleObj(),a=t.until,l=[];return a&&(t.until=a.toISOString().substr(0,19).replace(/-|:/g,"")+"Z"),e.each(t,function(e,n){"byday"===e&&(n=n.join(",")),n&&l.push(e.toUpperCase()+"="+n)}),"RRULE:"+l.join(";")},fromRule:function(e){var n,t,a,l=this;a={freq:null,interval:null},e=e.toUpperCase(),0===e.indexOf("RRULE:")&&(e=e.slice(6)),e.split(";").forEach(function(e,n,t){e=e.split("="),n=e[0].toLowerCase(),t=e[1],"byday"===n?t=t.split(","):"until"===n&&(t=Array.prototype.slice.call(t.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z?$/),1,7).map(function(e){return parseInt(e)}),t[1]--,t=new Date(Date.UTC.apply(Date.UTC,t))),a[n]=t});for(n in l.modes)if(t=l.modes[n],t.isRule(a)){l.currentMode=n;break}l.setUntilDate(a.until),l.getMode().fromRuleObj(a),l.$frequency.val(l.currentMode).trigger("change"),l._triggerChange()},getCls:function(){var e=this.settings.cssPrefix;return Array.prototype.slice.call(arguments).map(function(n){return e+"-"+n}).join(" ")},getUntilDate:function(){var e,n=this,t=n.settings.timezone;return n.$untilEnabled.is(":checked")&&(e=n.$until.val())?(e+="T00:00:00",e=t&&i?i.fromISO(e,{zone:t}).toJSDate():new Date(e)):null},setUntilDate:function(e){var n,t,a=this,l=a.settings.timezone,s=a.$untilEnabled.is(":checked");return e?(l&&i?(n={zone:l},e=i.isDateTime(e)?e:"string"==typeof e?i.fromISO(e,n):i.fromMillis(e.getTime(),n),t=e.toFormat("yyyy-LL-dd")):(e=new Date(e),t=e.getFullYear()+"-"+("0"+e.getMonth()).slice(-2)+"-"+("0"+e.getDate()).slice(-2)),a.$until.val(t),void(s||a.$untilEnabled.prop("checked",!0).trigger("change"))):void(s&&a.$untilEnabled.prop("checked",!1).trigger("change"))},_triggerChange:function(){e(this.element).trigger("change")}},e.fn.wsFormsRecurrence=function(n){return this.each(function(){var a=this,l="ws.forms.recurrence";e.data(a,l)||e.data(a,l,new t(a,n))}),this};var r=n.ws=n.ws||{};r.forms=e.extend(r.forms||{},{Recurrence:t})}(jQuery,window);