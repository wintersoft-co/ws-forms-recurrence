!function(e,n){"use strict";var t,l,a,s,i="wsFormsRecurrence",r=n.rrule?rrule.RRule:n.RRule;s={monday:{label:"M",rule:r.MO},tuesday:{label:"T",rule:r.TU},wednesday:{label:"W",rule:r.WE},thursday:{label:"T",rule:r.TH},friday:{label:"F",rule:r.FR},saturday:{label:"S",rule:r.SA},sunday:{label:"S",rule:r.SU}},a={modes:["weekly","monthly"],debounce:200,cssPrefix:"ws-form",timezone:null,days:Object.keys(s),minDays:1,maxDays:7,strings:{frequencyLabel:"Frequency",frequencyHint:null,weekly:"Weekly",weeksLabel:"Every",weeksHint:"weeks(s)",daysLabel:"On",daysHint:null,dayNames:Object.keys(s).map(function(e){return e[0].toUpperCase()+e[1]}),monthly:"Monthly",monthsLabel:"Every",monthsHint:"month(s)",untilLabel:null,untilHint:null,untilEnabledLabel:"Until"}},l={weekly:function(e){var n=this;n.plugin=e,n.init()},monthly:function(e){var n=this;n.plugin=e,n.init()}},l.weekly.prototype={init:function(){var n,t,l,a,i,r,o,u=this,d=u.plugin,c=d.settings,p=c.strings,f=d.getCls.bind(d);n=u.$el=e('<div class="'+f("fieldset","fieldset-weekly")+'"></div>'),a=e('<label class="'+f("field","field-weeks")+'"></label>'),p.weeksLabel&&a.append('<span class="'+f("field-label")+'">'+p.weeksLabel+"</span>"),t=u.$weeks=e('<input type="number" min="1" pattern="/^d+$/"/>'),t.val(i=1),r=function(e){var n=t.val().replace(/[^\d]/g,"");t.val(n),i!==n&&d._triggerChange(),i=n,e&&e.stopPropagation()},t.on("change",r),t.on("keyup",function(){clearTimeout(o),o=setTimeout(r,c.debounce)}),e('<span class="'+f("field-element")+'"></span>').append(t).appendTo(a),p.weeksHint&&a.append('<span class="'+f("field-hint")+'">'+p.weeksHint+"</span>"),n.append(a),a=e('<label class="'+f("field","field-days")+'"></label>'),p.daysLabel&&a.append('<span class="'+f("field-label")+'">'+p.daysLabel+"</span>"),l=e('<span class="'+f("field-element")+'"></span>'),u.days=[],c.days.forEach(function(n,t){if(t=s[n]){var a=e('<button type="button" class="'+f("day-"+t.rule.weekday)+'">'+p.dayNames[t.rule.weekday]+"</button>");a.on("click",function(){var e=d.settings.maxDays,t=u.getSelectedDays(),l=t.filter(function(e){return e!=n});l.length==t.length&&l.push(n),l.length>e&&l.shift(),u.setSelectedDays(l)&&d._triggerChange()}),l.append(a),u.days.push({name:n,selected:!1,$el:a})}}),a.append(l),n.append(a),p.daysHint&&a.append('<span class="'+f("field-hint")+'">'+p.daysHint+"</span>"),n.append(a)},getSelectedDays:function(){var e=this,n=[];return e.days.forEach(function(e){e.selected&&n.push(e.name)}),n},setSelectedDays:function(e){var n=this;return n.isValidDays(e)?(n.days.forEach(function(t){t.selected=e.indexOf(t.name)>-1,t.$el.toggleClass(n.plugin.getCls("active"),t.selected)}),!0):(console.warn("Invalid days set: ["+e+"]"),!1)},toObject:function(){var e=this;return{weeks:parseInt(e.$weeks.val()),days:e.getSelectedDays()}},toRule:function(){var e=this,n=e.toObject();return new r({freq:r.WEEKLY,interval:n.weeks,byweekday:n.days.map(function(e){return s[e].rule})})},fromRule:function(n){var t=this,l=n.options,a=[];t.$weeks.val(l.interval),e.each(s,function(e,n){l.byweekday.indexOf(n.rule.weekday)>=0&&a.push(e)}),t.setSelectedDays(a)},isRule:function(e){return e.options.freq===r.WEEKLY},isValidDays:function(e){var n=this,t=n.plugin.settings,l=t.minDays,a=t.maxDays;return("number"!=typeof l||e.length>=l)&&("number"!=typeof a||e.length<=a)}},l.monthly.prototype={init:function(){var n,t,l,a,s,i,r=this,o=r.plugin,u=o.settings,d=u.strings,c=o.getCls.bind(o);n=r.$el=e('<div class="'+c("fieldset","fieldset-monthly")+'"></div>'),l=e('<label class="'+c("field","field-months")+'"></label>'),d.monthsLabel&&l.append('<span class="'+c("field-label")+'">'+d.monthsLabel+"</span>"),t=r.$months=e('<input type="number" min="1" pattern="/^d+$/"/>'),t.val(a=1),s=function(e){var n=t.val().replace(/[^\d]/g,"");t.val(n),a!==n&&o._triggerChange(),a=n,e&&e.stopPropagation()},t.on("change",s),t.on("keyup",function(){clearTimeout(i),i=setTimeout(s,u.debounce)}),e('<span class="'+c("field-element")+'"></span>').append(t).appendTo(l),d.monthsHint&&l.append('<span class="'+c("field-hint")+'">'+d.monthsHint+"</span>"),n.append(l)},toObject:function(){return{months:parseInt(this.$months.val())}},toRule:function(){var e=this.toObject();return new r({freq:r.MONTHLY,interval:e.months})},fromRule:function(e){var n=e.options;this.$months.val(n.interval)},isRule:function(e){return e.options.freq===r.MONTHLY}},t=function(n,t){var l=this;l.$el=e(n),l.element=l.$el[0],l.settings=jQuery.extend({},a,t),l.settings.strings=jQuery.extend({},a.strings,t.strings),l._name=i,l.currentMode=null,l.init()},t.prototype={modes:null,init:function(){var n,t,a,s,i,r,o=this,u=o.settings,d=u.strings,c=o.getCls.bind(o),p=o.$el;p.addClass(c("wrap","wrap-recurrence")),n=e('<label class="'+c("field","field-frequency")+'"></label>'),d.frequencyLabel&&n.append('<span class="'+c("field-label")+'">'+d.frequencyLabel+"</span>"),t=o.$frequency=e("<select></select>"),t.on("change",function(){var e=t.val(),n=o.modes[e];if(!n)throw new Error("Unknown mode selected: "+e);o.hideAll(),n.$el.show(),o.currentMode=e}),e('<span class="'+c("field-element")+'"></span>').append(t).appendTo(n),d.frequencyHint&&n.append('<span class="'+c("field-hint")+'">'+d.frequencyHint+"</span>"),p.append(n),o.modes={},u.modes.forEach(function(e){var n=new l[e](o),a=n.$el;a.hide(),p.append(a),t.append('<option value="'+e+'">'+d[e]+"</option>"),o.modes[e]=n}),u.modes.length<2&&n.hide(),n=e('<label class="'+c("field","field-until")+'"></label>'),d.untilLabel&&n.append('<span class="'+c("field-label")+'">'+d.untilLabel+"</span>"),s=o.$untilEnabled=e('<input type="checkbox"/>'),a=o.$until=e('<input type="date"/>'),i=new Date,r=i.getMonth()+1,r>11&&i.setFullYear(i.getFullYear()+1),i.setMonth(r%12),a.val(i.toISOString().substring(0,10)),s.on("change",function(){a.toggle(s.is(":checked"))}),s.trigger("change"),e('<span class="'+c("field-element")+'"></span>').append(s).append(d.untilEnabledLabel&&'<span class="'+c("field-label")+'">'+d.untilEnabledLabel+"</span>").append(a).appendTo(n),d.untilHint&&n.append('<span class="'+c("field-hint")+'">'+d.untilHint+"</span>"),p.append(n),t.trigger("change"),o.fromRule(u.recurrenceRule||o.toRule().toString())},hideAll:function(){e.each(this.modes,function(e,n){n.$el.hide()})},getMode:function(e){var n=this,t=n.modes;return e&&t[e]||n.currentMode&&t[n.currentMode]},toObject:function(){var n,t=this,l=t.getMode().toObject();return t.$untilEnabled.is(":checked")&&(n=t.getUntilDate())?e.extend({},l,{until:n}):l},toRule:function(){var n,t=this,l=t.settings.timezone,a=t.getMode().toRule();return t.$untilEnabled.is(":checked")&&(n=t.getUntilDate())?new r(e.extend({},a.origOptions,{until:n,tzid:null===l?"UTC":null})):a},fromRule:function(e){var n,t,l=this,a="string"==typeof e?r.fromString(e):e;if(!(a instanceof r))throw new Error("Invalid argument - must be a string or RRule object: "+e);for(n in l.modes)if(t=l.modes[n],t.isRule(a)){l.currentMode=n;break}if(l.$untilEnabled.prop("checked",!!a.origOptions.until).trigger("change"),a.origOptions.until){var s=new Date(a.origOptions.until);l.$until.val(s.toISOString().substring(0,10))}l.getMode().fromRule(a),l.$frequency.val(l.currentMode).trigger("change"),this._triggerChange()},getCls:function(){var e=this.settings.cssPrefix;return Array.prototype.slice.call(arguments).map(function(n){return e+"-"+n}).join(" ")},getUntilDate:function(){var e,n=this,t=n.settings.timezone;return n.$untilEnabled.is(":checked")&&(e=n.$until.val())?(e=new Date(e+"T00:00:00"+(null===t?"Z":"")),null!==t&&(e=new r({dtstart:e,tzid:t}).all(function(e,n){return 1>n})[0]),e):null},_triggerChange:function(){e(this.element).trigger("change")}},e.fn[i]=function(n){return this.each(function(){var l=this,a="plugin-"+i;e.data(l,a)||e.data(l,a,new t(l,n))}),this};var o=n.ws=n.ws||{};o.forms=e.extend(o.forms||{},{Recurrence:t})}(jQuery,window);